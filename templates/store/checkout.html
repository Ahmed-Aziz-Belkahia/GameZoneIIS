{% extends "partials/base.html" %}
{% load static %}
{% block title %}
Checkout
 {% endblock title %}
{% block content %}
<style>
   ul,li{
      list-style: none;
   }
</style>
<div class="body_content_wrapper position-relative" style="margin-top: 40px;">
   <section class="inner_page_breadcrumb">
      <div class="container">
        <div class="row">
          <div class="col-xl-6">
            <div class="breadcrumb_content">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'store:home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'store:cart-view' %}">Magasin</a></li>
                <li class="breadcrumb-item"><a href="{% url 'store:cart-view' %}">Mon panier</a></li>
                <li class="breadcrumb-item"><a href="{% url 'store:shipping_address' %}">D√©tails de l'envoi et de la facturation</a></li>
                <li class="breadcrumb-item active" aria-current="page"><a>Sortie de caisse</a></li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </section>
   <!-- Shop Checkouts Content -->
   <section class="shop-checkouts pt30" >
      <div class="container">
         <div class="row">
            <div class="col-sm-6 col-lg-4 m-auto">
               <div class="main-title text-center mb50">
                  <h2 class="title">Passer √† la caisse maintenant üôÇ</h2>
               </div>
            </div>
         </div>
         <div class="row mt15" id="cartList">
            <div class="col-lg-8 col-xl-9">
               
               <div class="checkout_form style2">
                  
                  {% if address.billing_country != None %}
                  <h3 class="titfle mb20">D√©tails de l'exp√©dition</h3>
                  {% else %}
                  <h3 class="tiftle mb20">D√©tails de l'envoi et de la facturation</h3>
                  {% endif %}
                  <!-- <div class="alert alert-warning">
                     <strong>Please review your shipping address before placing an order</strong>
                  </div> -->
                  <a href="{% url 'store:shipping_address' %}" class="dashed-custom">Modifier l'adresse</a>
                  <div class="checkout_coupon ui_kit_button mt-4">
                     <form class="form2" id="coupon_form" name="contact_form" action="#" method="post">
                        <div class="row">
                           <div class="col-sm-12">
                              <div class="form-group">
                                 <label class="form-label">Nom et pr√©nom *</label>
                                 <input class="form-control form_control" type="text" readonly value="{{ address.full_name }}">
                              </div>
                           </div>
                           <div class="col-sm-4">
                              <div class="form-group">
                                 <label class="form-label">Votre Email</label>
                                 <input name="form_email" class="form-control form_control email" type="email" readonly value="{{ address.email }}">
                              </div>
                           </div>
                           <div class="col-sm-4">
                              <div class="form-group">
                                 <label class="form-label">T√©l√©phone *</label>
                                 <input name="form_phone" class="form-control form_control" type="text" readonly value="{{ address.mobile }}">
                              </div>
                           </div>
                           
                          
                           <div class="col-sm-4">
                              <div class="form-group">
                                 <label class="form-label">Pays*</label>
                                 <input class="form-control form_control" type="text" readonly value="{{ address.country }}">
                              </div>
                           </div>
                           <div class="col-sm-4">
                              <div class="form-group">
                                 <label class="form-label">√âtat</label>
                                 <input class="form-control form_control mb10" type="text" readonly value="{{ address.state }}">
                              </div>
                           </div>
                           <div class="col-sm-4">
                              <div class="form-group">
                                 <label class="form-label">Ville ou village</label>
                                 <input class="form-control form_control mb10" type="text" readonly value="{{ address.town_city }}">
                              </div>
                           </div>
                           <div class="col-sm-4">
                              <div class="form-group">
                                 <label class="form-label">Adresse personnelle</label>
                                 <input class="form-control form_control mb10" type="text" readonly value="{{ address.address }}">
                              </div>
                           </div>
                           <!-- <div class="col-sm-12">
                              <div class="form-group">
                                 <label class="form-label">Postal Code</label>
                                 <input class="form-control form_control mb10" type="text" readonly value="{{ address.postal_code }}">
                              </div>
                           </div> -->
                           {% if address.billing_country != None %}
                              <hr>
                              <h3 class="titfle mb20">D√©tails de la facture</h3>
                           {% endif %}
                           {% if address.billing_country != None %}

                           <div class="col-sm-6">
                              <div class="form-group">
                                 <label class="form-label">Pays de facturation*</label>
                                 <input class="form-control form_control" type="text" readonly value="{{ address.billing_country }}">
                              </div>
                           </div>
                           <div class="col-sm-6">
                              <div class="form-group">
                                 <label class="form-label">Etat de facturation</label>
                                 <input class="form-control form_control mb10" type="text" readonly value="{{ address.billing_state }}">
                              </div>
                           </div>
                           <div class="col-sm-6">
                              <div class="form-group">
                                 <label class="form-label">Localit√© de facturation</label>
                                 <input class="form-control form_control mb10" type="text" readonly value="{{ address.billing_town_city }}">
                              </div>
                           </div>
                           <div class="col-sm-6">
                              <div class="form-group">
                                 <label class="form-label">Adresse de facturation</label>
                                 <input class="form-control form_control mb10" type="text" readonly value="{{ address.billing_address }}">
                              </div>
                           </div>
                           <!-- <div class="col-sm-12">
                              <div class="form-group">
                                 <label class="form-label">Billing Postal Code</label>
                                 <input class="form-control form_control mb10" type="text" readonly value="{{ address.billing_postal_code }}">
                              </div>
                           </div> -->
                           {% endif %}
                        </div>
                     </form>
                     <div class="ui_kit_button payment_widget_btn">
                        <input type="hidden" value="{{address.email}}" id="email">
                     </div>
                  </div>
               </div>
            </div>
            <div class="col-lg-4 col-xl-3">
                <p class="para">Vous allez payer <span class="cart-list"><b>{{order_items.count}}</b></span>article(s)</p>
                <div class="order_sidebar_widget checkout_page mb30 mb30">
                    <h4 class="title">Votre commande</h4>
                    <ul>
                       <li class="subtitle">
                          <p>Sous-total <span class="float-end totals">{{ cs }}{{order.price|floatformat:2}}</span></p>
                       </li>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                       <li class="subtitle">
                          <p>Livraison <span class="float-end totals">{{ cs }}{{ order.shipping|floatformat:2 }}</span></p>
                       </li>
                       
                       <li class="subtitle">
                        <p>Estimation {{tax_country.custom_name}} <span class="float-end totals">{{ cs }}{{ order.vat|floatformat:2 }}</span></p>
                        </li>
                        <li class="subtitle">
                           <p>Frais de services <span class="float-end totals">{{ cs }}{{ order.service_fee|floatformat:2 }}</span></p>
                           </li>
                       <li class="subtitle">
                          <p>Totale  <span class="float-end totals">{{cs}}{{order.original_total|floatformat:2}}</span></p>
                          
                          {% if order.saved != 0.00 %}
                           (<span style="font-size: 10px; margin-bottom: -10px;"><small>Avant la remise</small></span>)
                          {% endif %}
                           
                       </li>
                       {% if order.saved != 0.00 %}
                        <li class="subtitle">
                           <p style="color: green;">Totale  <span class="float-end totals">{{cs}}{{order.total|floatformat:2}}</span></p>
                           <small style="color: red;">Remise : <span class="float-end totals">-{{cs}}{{order.saved|floatformat:2}}</span></small>
                        </li>
                     {% endif %}
                    </ul>
                 </div>
                 <div class="checkout_form mt30 mb50">
                  <div class="checkout_coupon posr d-flex  mb-2">
                    <form class="form_one posr mb10-lg d-flex d-md-blfock" method="POST">
                      {% csrf_token %}
                      <input class="form-control coupon_input" name="code" type="search" placeholder="Redeem Coupon Code" aria-label="Search">
                      <button type="submit" class="apply_rcount_btn purple-btn" style="height: 4px; padding-bottom: 30px; margin-top: 7px;"><i class="fas fa-check-circle"></i></button>
                    </form>
                  </div>
                  {% for c in order.coupons.all %}
                     
                     {% if c.type == "Flat Rate" %}
                        <small style="color: green; font-size: 12px;"><b class="text-success" >{{ cs }}{{c.discount}} OFF - {{c.code}}</b> Activated.</small> <br>
                     {% else %}
                        <small style="color: green; font-size: 12px;"><b class="text-success" >{{c.discount}}% OFF - {{c.code}}</b> Activated.</small> <br>
                     {% endif %}
                        
                  {% endfor %}
                </div>
                 <div class="ui_kit_button payment_widget_btn">
                  {% if order.payment_method == "credit_card" %}
                  <button  button id="checkout-button" class="btn btn-track purple-btn w100 mt20">Paiement par carte de cr√©dit  <i class="fas fa-credit-card"></i></button>
                  {% else %}
                  <button  button id="place-order-button" class="place-order-button btn btn-track purple-btn w100 mt20">Commander</button>
                  {% endif %}
                  {% comment %} <button class="btn btn-track purple-btn w100 mt10" style="height: 80px;">Pay with PayPal <i class="fab fa-paypal"></i> {{paypal_payment_button.render}}</button> {% endcomment %}
               </div>
            </div>
         </div>
         <br>
         <br>
         <br>
        
      </div>
   </section>

</div>
<script src="https://js.stripe.com/v3/"></script>
<script type="text/javascript">
   $(document).ready(function() {
       console.log("Document ready");

       // Checkout button click event handler
       $('#checkout-button').on('click', function() {
           console.log("Checkout button clicked");

           // Your existing checkout button logic here
           var email = document.getElementById('email').value;
           if (email.length == 0) {
               alert("Please enter your email address.");
               return;
           }
           fetch("{% url 'store:api_checkout_session' id=order.oid %}", {
                   method: 'POST',
                   body: JSON.stringify({
                       email: email
                   })
               })
               .then(function(response) {
                   console.log(response);
                   return response.json();
               })
               .then(function(response) {
                   console.log(response)
                   return window.location.href = response.payUrl;
               })
               .then(function(result) {
                   if (result.error) {
                       alert(result.error.message);
                   }
               })
               .catch(function(error) {
                   console.error('Error:', error);
               });
       });

       // Place Order button click event handler
       $('#place-order-button').on('click', function() {
           console.log("Place Order button clicked");
           window.location.href = '{% url 'store:api_checkout_session' id=order.oid %}';
           // Your existing place order button logic here
       });
   });
</script>
{% endblock content %}