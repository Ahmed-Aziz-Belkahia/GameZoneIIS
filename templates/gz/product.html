{% extends "gz/base.html" %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static "gz/styles/product.css" %}">
    {% block title %}<title>{{ product.title }}</title>{% endblock title %}
{% endblock head %}

{% block header %}
    {% include 'gz/components/navigation.html' %}
{% endblock header %}

{% block main %}
    <div class="main__product">
        <div class="product__div">
            <div class="product__product flexCenter">
                <div class="product__url">{{ product.subcategories }}</div>
                <div class="product__info flexCenter">
                    <div class="left__pictures-container flexCenter">
                        <div class="pictures-container__sideImages">
                            <div class="sideImages__div flexCenter">
                                <div class="sideImages__sideImage flexCenter">
                                    <img src="{{ product.image.url }}" alt="">
                                </div>
                                {% for subImage in product.subImages.all %}
                                    <div class="sideImages__sideImage flexCenter">
                                        <img src="{{ subImage.image.url }}" alt="">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="pictures-container__mainImage" id="mainImageContainer">
                            <img src="{{ product.image.url }}" alt="" id="mainImage">
                            <div class="zoom-circle" id="zoomCircle"></div>
                        </div>
                    </div>
                    <div class="info__right">
                        <div class="right__title">{{ product.title }}</div>
                        <div class="right__manufacturer">{{ product.manufacturer }}</div>
                        <div class="right__reviews flexCenter">
                            <div class="reviews__stars">
                                {% for star in "xxxxx"|make_list %}
                                    {% if forloop.counter <= reviews %}
                                        <div class="stars__star"><i class="fa-solid fa-star"></i></div>
                                    {% else %}
                                        <div class="stars__star"><i class="fa-regular fa-star"></i></div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="reviews__numbers"><a href="#"> 4.5 (15)</a></div>
                        </div>
                        <div class="right__price flexCenter">
                            <div class="price__current">{{ product.price }} DT</div>
                        </div>
                        <div class="points">
                            <div class="points__div">Vous collectez {{ product.points }} GZ Coins</div>
                        </div>
                        {% for type in product.types.all %}
                            <div class="right__choices">
                                <div class="choices__label">
                                    {{ type.name }}: <span></span>
                                </div>
                                <form class="choice-form" method="POST" action="">
                                    {% csrf_token %}
                                    <div class="choices__divs">
                                        {% for choice in type.choices.all %}
                                            <div class="divs__div choice flexCenter" data-choice-id="{{ choice.name }}">
                                                <img src="{{ choice.img.url }}" alt="{{ choice.name }}">
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" class="selected-choice-input" name="selected_choice" value="">
                                </form>
                            </div>
                        {% endfor %}
                        <div class="right__shipping">
                            <div class="shipping__div">Livraison GRATUITE à partir de 300 DT</div>
                            <div class="shipping__div">Expédition en 24h</div>
                        </div>
                        <div class="right__button flexCenter">
                            <a class="add-to-cart">Ajouter au panier</a>
                            <a class="buy-now">Acheter</a>
                        </div>
                    </div>
                </div>
                <div class="info__left">
                    <div class="bottom__desctiption">
                        <div class="description__features">
                            <div class="features__title">Features:</div>
                            <ul class="features__container">
                                {% for feature in product.feature_set.all %}
                                    <li class="features__div">
                                        <strong>{{ feature.title }}</strong><p>{{ feature.description }}</p>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="description__full-description">
                            <div class="full-description__title">Description du produit:</div>
                            <div class="full-description__content">{{ product.description }}</div>
                        </div>
                        <div class="Specifications">
                            <div class="features__title">Spécifications:</div>
                            <div class="product-accordion-panel">
                                {% for spec in product.specification_set.all %}
                                    <div class="product-attribute-redesign">
                                        <h3 class="product-attribute-group-name">{{ spec.title }}</h3>
                                        <div class="col specifications js-productFeatures">
                                            <table class="product-attribute-table-redesign">
                                                <tbody>
                                                    {% for value in spec.value_set.all %}
                                                        <tr>
                                                            <th>{{ value.title }}</th>
                                                            <td>{{ value.description }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% include 'gz/components/relatedProductsCatalog.html' %}
        </div>
    </div>
{% endblock main %}

{% block footer %}
    {% include "gz/components/footer.html" %}
{% endblock footer %}

{% block scripts %}
<script>
    $(document).ready(function() {
        const mainImage = $("#mainImage");
        const zoomCircle = $("#zoomCircle");
        const mainImageContainer = $("#mainImageContainer");
        const sideImages = $(".sideImages__sideImage img");

        // Function to change main image and reset zoom on side image click
        function changeMainImage(imageSrc) {
            mainImage.attr("src", imageSrc);
            mainImage.css("background-position", "0 0"); // Reset background position for zoom
            zoomCircle.hide(); // Hide zoom circle
        }

        // Event listener for side image click
        sideImages.on("click", function() {
            const newImageSrc = $(this).attr("src");
            changeMainImage(newImageSrc);
        });

        // Function to handle choice selection
        $(".choice-form").on("click", ".divs__div.choice", function() {
            const selectedChoice = $(this);
            const selectedChoiceId = selectedChoice.data("choice-id");

            // Remove 'selected' class from all choices within the same container
            selectedChoice.siblings().removeClass("selected");
            // Add 'selected' class to the clicked choice
            selectedChoice.addClass("selected");

            // Set the selected choice ID to the hidden input within the same container
            selectedChoice.closest(".right__choices").find(".selected-choice-input").val(selectedChoiceId);
        });

        // Set the first choice as selected by default
        $(".right__choices").each(function() {
            const firstChoice = $(this).find(".divs__div.choice:first");
            firstChoice.addClass("selected");
            const selectedChoiceId = firstChoice.data("choice-id");
            $(this).find(".selected-choice-input").val(selectedChoiceId);
        });

        // Prevent form submission on button click if no choice is selected
        $(".choice-form").submit(function(e) {
            const selectedInput = $(this).find(".selected-choice-input");
            if (selectedInput.val() === "") {
                e.preventDefault();
                alert("Please select a choice before submitting.");
            }
        });

        // Handle "Add to Cart" and "Buy Now" button clicks
        $(".right__button").on("click", ".add-to-cart, .buy-now", function(e) {
            e.preventDefault();
            const types = []; // Corrected the declaration of the types array

            // Iterate over each type's selected choice
            $(".right__choices").each(function() {
                const selectedChoiceId = $(this).find(".selected-choice-input").val();
                const typeName = $(this).find(".choices__label").text().trim();

                // Corrected the syntax for adding objects to the types array
                types.push({ [typeName]: selectedChoiceId });

                // Log the selected choice ID and type name (you can modify this to send to the server)
                console.log("Type: " + typeName + ", Selected Choice ID: " + selectedChoiceId);
            });

            $.ajax({
                type: 'POST',
                url: '/add-to-cart/',
                data: {
                    "product_id": {{ product.id }},
                    "types": JSON.stringify(types) // Convert types array to a JSON string
                },
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader('X-CSRFToken', getCookie("csrftoken"));
                },
                success: function(response) {
                    console.log(response);
                    if ($(this).is(".add-to-cart")) {
                        window.location.reload();
                    } else if ($(this).is(".buy-now")) {
                        window.location.href = "/cart/";
                    }
                },
                error: function(error) {
                    console.error('Error :', error);
                    window.location.href = "/login/";
                }
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock scripts %}
